(ns semvera.core-test
  (:require [clojure.test :refer :all]
            [semvera.core :refer :all]))

(defn- greater-than? [x y]
  (let [x-semver (semver x)
        y-semver (semver y)]
    (and (>' x-semver y-semver)
         (<' y-semver x-semver)
         (=' x-semver x-semver)
         (=' y-semver y-semver)
         (not=' x-semver y-semver))))

(deftest x-should-be-greater-than-y
  (are [x y] (greater-than? x y)
    "0.0.0", "0.0.0-foo"
    "0.0.1", "0.0.0"
    "1.0.0", "0.9.9"
    "0.10.0", "0.9.0"
    "0.99.0", "0.10.0"
    "2.0.0", "1.2.3"
    "v0.0.0", "0.0.0-foo"
    "v0.0.1", "0.0.0"
    "v1.0.0", "0.9.9"
    "v0.10.0", "0.9.0"
    "v0.99.0", "0.10.0"
    "v2.0.0", "1.2.3"
    "0.0.0", "v0.0.0-foo"
    "0.0.1", "v0.0.0"
    "1.0.0", "v0.9.9"
    "0.10.0", "v0.9.0"
    "0.99.0", "v0.10.0"
    "2.0.0", "v1.2.3"
    "1.2.3", "1.2.3-asdf"
    "1.2.3", "1.2.3-4"
    "1.2.3", "1.2.3-4-foo"
    "1.2.3-5-foo", "1.2.3-5"
    "1.2.3-5", "1.2.3-4"
    "1.2.3-5-foo", "1.2.3-5-Foo"
    "3.0.0", "2.7.2+asdf"
    "1.2.3-a.10", "1.2.3-a.5"
    "1.2.3-a.b", "1.2.3-a.5"
    "1.2.3-a.b", "1.2.3-a"
    "1.2.3-a.b.c.10.d.5", "1.2.3-a.b.c.5.d.100"
    "1.2.3-r2", "1.2.3-r100"
    "1.2.3-r100", "1.2.3-R2"))

(defn- equal? [x y]
  (let [x-semver (semver x)
        y-semver (semver y)]
    (and (=' x-semver y-semver)
         (not (not=' y-semver x-semver)))))

(deftest semvers-should-be-equal
  (are [x y] (equal? x y)
    "1.2.3", "v1.2.3"
    "1.2.3", "=1.2.3"
    "1.2.3", "v 1.2.3"
    "1.2.3", "= 1.2.3"
    "1.2.3", " v1.2.3"
    "1.2.3", " =1.2.3"
    "1.2.3", " v 1.2.3"
    "1.2.3", " = 1.2.3"
    "1.2.3-0", "v1.2.3-0"
    "1.2.3-0", "=1.2.3-0"
    "1.2.3-0", "v 1.2.3-0"
    "1.2.3-0", "= 1.2.3-0"
    "1.2.3-0", " v1.2.3-0"
    "1.2.3-0", " =1.2.3-0"
    "1.2.3-0", " v 1.2.3-0"
    "1.2.3-0", " = 1.2.3-0"
    "1.2.3-1", "v1.2.3-1"
    "1.2.3-1", "=1.2.3-1"
    "1.2.3-1", "v 1.2.3-1"
    "1.2.3-1", "= 1.2.3-1"
    "1.2.3-1", " v1.2.3-1"
    "1.2.3-1", " =1.2.3-1"
    "1.2.3-1", " v 1.2.3-1"
    "1.2.3-1", " = 1.2.3-1"
    "1.2.3-beta", "v1.2.3-beta"
    "1.2.3-beta", "=1.2.3-beta"
    "1.2.3-beta", "v 1.2.3-beta"
    "1.2.3-beta", "= 1.2.3-beta"
    "1.2.3-beta", " v1.2.3-beta"
    "1.2.3-beta", " =1.2.3-beta"
    "1.2.3-beta", " v 1.2.3-beta"
    "1.2.3-beta", " = 1.2.3-beta"
    "1.2.3-beta+build", " = 1.2.3-beta+otherbuild"
    "1.2.3+build", " = 1.2.3+otherbuild"
    "1.2.3-beta+build", "1.2.3-beta+otherbuild"
    "1.2.3+build", "1.2.3+otherbuild"
    " v1.2.3+build", "1.2.3+otherbuild"))

(deftest semver-should-be-in-range
  (are [range x] (in-range? (semver-range range) (semver x))
    "1.0.0 - 2.0.0", "1.2.3"
    "^1.2.3+build", "1.2.3"
    "^1.2.3+build", "1.3.0"
    "1.2.3-pre+asdf - 2.4.3-pre+asdf", "1.2.3"
    "1.2.3pre+asdf - 2.4.3-pre+asdf", "1.2.3"
    "1.2.3-pre+asdf - 2.4.3pre+asdf", "1.2.3"
    "1.2.3pre+asdf - 2.4.3pre+asdf", "1.2.3"
    "1.2.3-pre+asdf - 2.4.3-pre+asdf", "1.2.3-pre.2"
    "1.2.3-pre+asdf - 2.4.3-pre+asdf", "2.4.3-alpha"
    "1.2.3+asdf - 2.4.3+asdf", "1.2.3"
    "1.0.0", "1.0.0"
    ">=*", "0.2.4"
    "*", "1.2.3"
    "*", "v1.2.3-foo"
    ">=1.0.0", "1.0.0"
    ">=1.0.0", "1.0.1"
    ">=1.0.0", "1.1.0"
    ">1.0.0", "1.0.1"
    ">1.0.0", "1.1.0"
    "<=2.0.0", "2.0.0"
    "<=2.0.0", "1.9999.9999"
    "<=2.0.0", "0.2.9"
    "<2.0.0", "1.9999.9999"
    "<2.0.0", "0.2.9"
    ">= 1.0.0", "1.0.0"
    ">= 1.0.0", "1.0.1"
    ">= 1.0.0", "1.1.0"
    "> 1.0.0", "1.0.1"
    "> 1.0.0", "1.1.0"
    "<= 2.0.0", "2.0.0"
    "<= 2.0.0", "1.9999.9999"
    "<= 2.0.0", "0.2.9"
    "< 2.0.0", "1.9999.9999"
    "<\t2.0.0", "0.2.9"
    ">=0.1.97", "v0.1.97"
    ">=0.1.97", "0.1.97"
    "0.1.20 || 1.2.4", "1.2.4"
    ">=0.2.3 || <0.0.1", "0.0.0"
    ">=0.2.3 || <0.0.1", "0.2.3"
    ">=0.2.3 || <0.0.1", "0.2.4"
    "2.x.x", "2.1.3"
    "1.2.x", "1.2.3"
    "1.2.x || 2.x", "2.1.3"
    "1.2.x || 2.x", "1.2.3"
    "x", "1.2.3"
    "2.*.*", "2.1.3"
    "1.2.*", "1.2.3"
    "1.2.* || 2.*", "2.1.3"
    "1.2.* || 2.*", "1.2.3"
    "*", "1.2.3"
    "2", "2.1.2"
    "2.3", "2.3.1"
    "~2.4", "2.4.0" ; >=2.4.0 <2.5.0
    "~2.4", "2.4.5"
    "~>3.2.1", "3.2.2" ; >=3.2.1 <3.3.0
    "~1", "1.2.3" ; >=1.0.0 <2.0.0
    "~>1", "1.2.3"
    "~> 1", "1.2.3"
    "~1.0", "1.0.2" ; >=1.0.0 <1.1.0
    "~ 1.0", "1.0.2"
    "~ 1.0.3", "1.0.12"
    ">=1", "1.0.0"
    ">= 1", "1.0.0"
    "<1.2", "1.1.1"
    "< 1.2", "1.1.1"
    "~v0.5.4-pre", "0.5.5"
    "~v0.5.4-pre", "0.5.4"
    "=0.7.x", "0.7.2"
    "<=0.7.x", "0.7.2"
    ">=0.7.x", "0.7.2"
    "<=0.7.x", "0.6.2"
    "~1.2.1 >=1.2.3", "1.2.3"
    "~1.2.1 =1.2.3", "1.2.3"
    "~1.2.1 1.2.3", "1.2.3"
    "~1.2.1 >=1.2.3 1.2.3", "1.2.3"
    "~1.2.1 1.2.3 >=1.2.3", "1.2.3"
    "~1.2.1 1.2.3", "1.2.3"
    ">=1.2.1 1.2.3", "1.2.3"
    "1.2.3 >=1.2.1", "1.2.3"
    ">=1.2.3 >=1.2.1", "1.2.3"
    ">=1.2.1 >=1.2.3", "1.2.3"
    ">=1.2", "1.2.8"
    "^1.2.3", "1.8.1"
    "^0.1.2", "0.1.2"
    "^0.1", "0.1.2"
    "^1.2", "1.4.2"
    "^1.2 ^1", "1.4.2"
    "^1.2.3-alpha", "1.2.3-pre"
    "^1.2.0-alpha", "1.2.0-pre"
    "^0.0.1-alpha", "0.0.1-beta"
    ; Extra tests (not in node-semver)
    "1.2.3-beta - 4.5.6-beta", "1.2.3-beta"
    "1.2.3-beta - 4.5.6-beta", "4.5.6-beta"
    "1.2.3-beta - 4.5.6-beta", "1.2.3-rc"
    "1.2.3-beta - 4.5.6-beta", "4.5.6-alpha"
    ">1", "2.0.0"
    ">1.1", "1.2.0"
    ">1.1", "2.0.0"
    ">1.1.1", "1.2.0"
    ">1.1.1", "2.0.0"
    ">=1", "1.0.0"
    ">=1", "1.2.0"
    ">=1", "2.0.0"
    "<1", "0.9.0"
    "<2", "0.9.0"
    "<2", "1.0.0"
    "<2", "1.1.0"
    "<2", "1.9.0"
    "<=1", "0.9.0"
    "<=1", "1.0.0"
    "<=1", "1.1.0"
    ">0.7.x", "0.8.0"
    ">0.7.x", "1.0.0"
    "1.2.3 - 2.3", "1.2.3"
    "1.2.3 - 2.3", "1.3.0"
    "1.2.3 - 2.3", "2.3.0"
    "1.2.3 - 2.3", "2.3.9"
    "1.2.3 - 2", "1.2.3"
    "1.2.3 - 2", "1.3.0"
    "1.2.3 - 2", "2.3.0"
    "1.2.3 - 2", "2.3.9"
    "1.2.3 - 2", "2.9.9"))

(deftest semver-should-not-be-in-range
  (are [range x] (not (in-range? (semver-range range) (semver x)))
    "1.0.0 - 2.0.0", "2.2.3"
    "1.2.3+asdf - 2.4.3+asdf", "1.2.3-pre.2"
    "1.2.3+asdf - 2.4.3+asdf", "2.4.3-alpha"
    "^1.2.3+build", "2.0.0"
    "^1.2.3+build", "1.2.0"
    "^1.2.3", "1.2.3-pre"
    "^1.2", "1.2.0-pre"
    ">1.2", "1.3.0-beta"
    "<=1.2.3", "1.2.3-beta"
    "^1.2.3", "1.2.3-beta"
    "=0.7.x", "0.7.0-asdf"
    ">=0.7.x", "0.7.0-asdf"
    "1", "1.0.0beta"
    "<1", "1.0.0beta"
    "< 1", "1.0.0beta"
    "1.0.0", "1.0.1"
    ">=1.0.0", "0.0.0"
    ">=1.0.0", "0.0.1"
    ">=1.0.0", "0.1.0"
    ">1.0.0", "0.0.1"
    ">1.0.0", "0.1.0"
    "<=2.0.0", "3.0.0"
    "<=2.0.0", "2.9999.9999"
    "<=2.0.0", "2.2.9"
    "<2.0.0", "2.9999.9999"
    "<2.0.0", "2.2.9"
    ">=0.1.97", "v0.1.93"
    ">=0.1.97", "0.1.93"
    "0.1.20 || 1.2.4", "1.2.3"
    ">=0.2.3 || <0.0.1", "0.0.3"
    ">=0.2.3 || <0.0.1", "0.2.2"
    "2.x.x", "1.1.3"
    "2.x.x", "3.1.3"
    "1.2.x", "1.3.3"
    "1.2.x || 2.x", "3.1.3"
    "1.2.x || 2.x", "1.1.3"
    "2.*.*", "1.1.3"
    "2.*.*", "3.1.3"
    "1.2.*", "1.3.3"
    "1.2.* || 2.*", "3.1.3"
    "1.2.* || 2.*", "1.1.3"
    "2", "1.1.2"
    "2.3", "2.4.1"
    "~2.4", "2.5.0" ; >=2.4.0 <2.5.0
    "~2.4", "2.3.9"
    "~>3.2.1", "3.3.2" ; >=3.2.1 <3.3.0
    "~>3.2.1", "3.2.0" ; >=3.2.1 <3.3.0
    "~1", "0.2.3" ; >=1.0.0 <2.0.0
    "~>1", "2.2.3"
    "~1.0", "1.1.0" ; >=1.0.0 <1.1.0
    "<1", "1.0.0"
    ">=1.2", "1.1.1"
    "1", "2.0.0beta"
    "~v0.5.4-beta", "0.5.4-alpha"
    "=0.7.x", "0.8.2"
    ">=0.7.x", "0.6.2"
    "<0.7.x", "0.7.2"
    "<1.2.3", "1.2.3-beta"
    "=1.2.3", "1.2.3-beta"
    ">1.2", "1.2.8"
    "^1.2.3", "2.0.0-alpha"
    "^1.2.3", "1.2.2"
    "^1.2", "1.1.9"
    ; Extra tests (not in node-semver)
    "1.2.3-beta - 4.5.6-beta", "1.2.4-beta"
    "1.2.3-beta - 4.5.6-beta", "4.5.5-beta"
    "1.2.3-beta - 4.5.6-beta", "2.2.2-beta"
    "1.2.3-beta - 4.5.6-beta", "1.2.3-alpha"
    "1.2.3-beta - 4.5.6-beta", "4.5.6-rc"
    "<1", "1.0.0"
    "<1", "1.2.0"
    "<1", "2.0.0"
    "<=1", "2.0.0"
    ">1", "0.9.0"
    ">1", "1.0.0"
    ">1", "1.2.0"
    ">=1", "0.9.0"
    ">0.7.x", "0.6.0"
    ">0.7.x", "0.7.0"
    ">0.7.x", "0.7.0"
    "1.2.3 - 2.3", "1.0.0"
    "1.2.3 - 2.3", "1.2.2"
    "1.2.3 - 2.3", "2.4.0"
    "1.2.3 - 2", "1.0.0"
    "1.2.3 - 2", "3.0.0"))

(deftest should-be-able-to-get-major-from-semver
  (are [x major] (= (:major (semver x)) major)
    "1.2.3" 1
    " 1.2.3 " 1
    " 2.2.3-4 " 2
    " 3.2.3-pre " 3
    "v5.2.3" 5
    " v8.2.3 " 8
    "\t13.2.3" 13
    "=21.2.3" 21
    "v=34.2.3" 34))

(deftest should-be-able-to-get-minor-from-semver
  (are [x minor] (= (:minor (semver x)) minor)
    "1.1.3" 1
    " 1.1.3 " 1
    " 1.2.3-4 " 2
    " 1.3.3-pre " 3
    "v1.5.3" 5
    " v1.8.3 " 8
    "\t1.13.3" 13
    "=1.21.3" 21
    "v=1.34.3" 34))

(deftest should-be-able-to-get-patch-from-semver
  (are [x patch] (= (:patch (semver x)) patch)
    "1.2.1" 1
    " 1.2.1 " 1
    " 1.2.2-4 " 2
    " 1.2.3-pre " 3
    "v1.2.5" 5
    " v1.2.8 " 8
    "\t1.2.13" 13
    "=1.2.21" 21
    "v=1.2.34" 34))

(deftest test-semver->str
  (are [x expected] (= (str (semver x)) expected)
    "1.0.0", "1.0.0"
    "1.0.0alpha", "1.0.0-alpha"
    "v1.0.0", "1.0.0"
    "01.0.0", "1.0.0"
    "v01.0.0", "1.0.0"
    "=1.2.3", "1.2.3"))

(deftest test-semver-range->str
  (are [x expected] (= (str (semver-range x)) expected)
    "~3.0.3", ">=3.0.3 <3.1.0"
    "~>3.0.3", ">=3.0.3 <3.1.0" ; ~ and ~> are synonyms in `node-semver`
    "~1.1", ">=1.1.0 <1.2.0"
    "~>1.1", ">=1.1.0 <1.2.0"
    "^0", ">=0.0.0 <1.0.0"
    "^1", ">=1.0.0 <2.0.0"
    "^0.1", ">=0.1.0 <0.2.0"
    "^1.0", ">=1.0.0 <2.0.0"
    "^1.2", ">=1.2.0 <2.0.0"
    "^0.0.1", ">=0.0.1 <0.0.2"
    "^0.1.2", ">=0.1.2 <0.2.0"
    "^1.2.3", ">=1.2.3 <2.0.0"
    "1.2.3 - 2.3.4", ">=1.2.3 <=2.3.4"
    "1.2 - 2.3.4", ">=1.2.0 <=2.3.4"
    "1.2.3 - 2.3", ">=1.2.3 <2.4.0"
    "1.2.3 - 2", ">=1.2.3 <3.0.0"
    "1.x", ">=1.0.0 <2.0.0"
    "1.2.x", ">=1.2.0 <1.3.0"
    "1", ">=1.0.0 <2.0.0"
    "1.2", ">=1.2.0 <1.3.0"
    "~1.2.3", ">=1.2.3 <1.3.0"
    "~1.2", ">=1.2.0 <1.3.0"
    "~1", ">=1.0.0 <2.0.0"
    "~0.2.3", ">=0.2.3 <0.3.0"
    "~0.2", ">=0.2.0 <0.3.0"
    "~0", ">=0.0.0 <1.0.0"
    "~1.2.3-beta.2", ">=1.2.3-beta.2 <1.3.0"
    "^1.2.3", ">=1.2.3 <2.0.0"
    "^0.2.3", ">=0.2.3 <0.3.0"
    "^0.0.3", ">=0.0.3 <0.0.4"
    "^1.2.3-beta.2", ">=1.2.3-beta.2 <2.0.0"
    "^0.0.3-beta", ">=0.0.3-beta <0.0.4"
    "^1.2.x", ">=1.2.0 <2.0.0"
    "^0.0.x", ">=0.0.0 <0.1.0"
    "^0.0", ">=0.0.0 <0.1.0"
    "^1.x", ">=1.0.0 <2.0.0"
    "^0.x", ">=0.0.0 <1.0.0"))

(deftest test-semver-sorting-rules
  (are [actual expected] (= (sort (map semver actual))
                            (map semver expected))
    ["1.0.0" "1.0.0-beta.2" "1.0.0-beta.11" "1.0.0-alpha" "1.0.0-alpha.1" "1.0.0-rc.1" "1.0.0-alpha.beta" "1.0.0-beta"]
    ["1.0.0-alpha" "1.0.0-alpha.1" "1.0.0-alpha.beta" "1.0.0-beta" "1.0.0-beta.2" "1.0.0-beta.11" "1.0.0-rc.1" "1.0.0"]

    ["1.0.1" "0.1.0" "10.0.0" "0.0.1" "1.0.0" "0.22.5" "0.0.11" "2.0.0" "0.0.2" "111.111.111" "0.5.0"]
    ["0.0.1" "0.0.2" "0.0.11" "0.1.0" "0.5.0" "0.22.5" "1.0.0" "1.0.1" "2.0.0" "10.0.0" "111.111.111"]))

(deftest semver-should-be-invalid
  (are [x] (nil? (semver x))
    "1"
    "1.0"
    "1.0."
    ".0.0"
    "abc"
    "0123456789"
    "1-alpha"
    "z.2.3"
    "1.z.3"
    "1.2.z"
    ""))

(deftest semver-throws-exceptions-when-enabled
  (are [x] (thrown? Exception (semver x :throw-exceptions true))
    ""
    "1"
    "abc"))

(deftest semver-range-should-be-invalid
  (are [x] (nil? (semver-range x))
    ".0.0"
    "abc"
    "<"
    ">"
    "<="
    ">="
    "="
    "~"
    ">~"
    "^"
    "1.2.3.4"
    "1.2.3.4 5.6"
    ">=1.0.0.0"
    "???"))

(deftest semver-range-throws-exceptions-when-enabled
  (are [x] (thrown? Exception (semver-range x :throw-exceptions true))
    "invalid"
    "10.20.30.40"
    "alpha+500"))